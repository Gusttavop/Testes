
// =================================================================
// Parceiro de Programa√ß√£o: SCRIPT FINAL (V51.1 - IFRAME PROOF + DRAG MELHORADO)
// Mudan√ßas: apenas a fun√ß√£o de arraste (setupGPUDrag) foi substitu√≠da por V51.1.
// =================================================================

(function() {

    // --- IN√çCIO: KILL SWITCH ---
    try {
        const ids = ['pausa-script-container', 'pausa-script-config-container', 'pausa-script-drag-overlay'];
        ids.forEach(id => { const el = document.getElementById(id); if(el) el.remove(); });
    } catch (e) { console.warn(e); }
    // --- FIM: KILL SWITCH ---

    // ----------------------------------------------------
    // CONSTANTES E CONFIGURA√á√ïES
    // ----------------------------------------------------
    const SELECTORES = {
        MENU_STATUS_TOGGLE: '#toggleUserDropdownTarget',
        DISPONIVEL: 'button.presence-available',
        REFEICAO: 'button.presence-meal',
        INTERVALO_MENU: 'button.presence-break', 
        OCUPADO_MENU: 'button.presence-busy',   
        LOGOFF: 'span.menu-label', 
        NA_FILA_TOGGLE_HOST: 'gux-toggle#command-bar-queue-toggle', 
        NA_FILA_DIRETO: 'gux-button.onQueueButton',
        VOLTAR_SUBMENU: 'button[title="Volte √†s presen√ßas prim√°rias"]',
        STATUS_LABEL_TEXT: 'span.presence-label-text', 
        TREINAMENTO: 'button.presence-training',
        REUNIAO: 'button.presence-meeting',
    };

    const PAUSAS_AGENDADAS_DEFAULT = [
        { hora: "17:40", status: "Na fila" }, { hora: "18:35", status: "Pausa out" },
        { hora: "18:40", status: "Pausa auricular" }, { hora: "18:50", status: "Na fila" },
        { hora: "19:45", status: "Pausa out" }, { hora: "19:50", status: "Refei√ß√£o" },
        { hora: "20:10", status: "Na fila" }, { hora: "22:25", status: "Pausa out" },
        { hora: "22:30", status: "Pausa auricular" }, { hora: "22:40", status: "Na fila" },
        { hora: "00:00", status: "Logoff" }
    ];

    let estadoAtual = { tipo: 'Dispon√≠vel', inicio: new Date(), ativa: false };
    let historicoPausas = [];
    let isAgendamentoAtivo = false;
    let schedulerInterval = null;
    let syncTimeout = null;
    let ultimoEventoProcessado = null;
    let isConfigPainelAberto = false;
    let isAutomacaoPausada = false;
    
    // Vari√°vel para distinguir clique de arraste
    let globalWasDragging = false; 

    const STORAGE_KEY_HORARIOS = 'gerenciadorPausas_horarios';
    const STORAGE_KEY_POS_MAIN = 'gerenciadorPausas_posMain';
    const STORAGE_KEY_POS_CONFIG = 'gerenciadorPausas_posConfig';
    const STORAGE_KEY_NOTIF_CONFIG = 'gerenciadorPausas_notifConfig';

    const NOTIF_CONFIG_DEFAULT = { ativadas: true, somAtivado: false, antecedenciaSegundos: 15 };
    let configNotificacao = { ...NOTIF_CONFIG_DEFAULT };
    const SOM_NOTIFICACAO_URL = 'https://www.soundjay.com/button/sounds/beep-07a.mp3';
    let audioNotificacao = new Audio(SOM_NOTIFICACAO_URL);
    let audioDesbloqueado = false;

    // --- Fun√ß√µes de LocalStorage ---
    function salvarHorariosLocalStorage(h){try{localStorage.setItem(STORAGE_KEY_HORARIOS,JSON.stringify(h))}catch(e){}}
    function carregarHorariosLocalStorage(){try{const h=localStorage.getItem(STORAGE_KEY_HORARIOS);if(h){const p=JSON.parse(h);if(Array.isArray(p))return p;}}catch(e){}return[...PAUSAS_AGENDADAS_DEFAULT]}
    function salvarPosicaoPainelLocalStorage(k,el){if(!el)return;try{let p={};if(el.style.top&&el.style.left){p={top:el.style.top,left:el.style.left}}else{const r=el.getBoundingClientRect();p={bottom:'30px',right:'30px'}}localStorage.setItem(k,JSON.stringify(p))}catch(e){}}
    function carregarPosicaoPainelLocalStorage(k){try{const pS=localStorage.getItem(k);if(pS)return JSON.parse(pS)}catch(e){}return null}
    function salvarConfiguracoesNotificacaoLocalStorage(c){try{localStorage.setItem(STORAGE_KEY_NOTIF_CONFIG,JSON.stringify(c))}catch(e){}}
    function carregarConfiguracoesNotificacaoLocalStorage(){try{const cS=localStorage.getItem(STORAGE_KEY_NOTIF_CONFIG);if(cS)return{...NOTIF_CONFIG_DEFAULT,...JSON.parse(cS)}}catch(e){}return{...NOTIF_CONFIG_DEFAULT}}
    
    let PAUSAS_AGENDADAS=carregarHorariosLocalStorage();
    configNotificacao = carregarConfiguracoesNotificacaoLocalStorage();

    // ----------------------------------------------------
    // FUN√á√ïES DE UTILIDADE E INTERA√á√ÉO
    // ----------------------------------------------------
    function tocarSomNotificacao(){if(!configNotificacao.somAtivado)return;if(!audioDesbloqueado){desbloquearAudio(true);return}audioNotificacao.currentTime=0;audioNotificacao.play().catch(e=>{})}
    function desbloquearAudio(forcePlay=!1){if(audioDesbloqueado&&!forcePlay)return;let p=audioNotificacao.play();if(p!==undefined){p.then(()=>{audioNotificacao.pause();audioNotificacao.currentTime=0;if(!audioDesbloqueado){audioDesbloqueado=!0}}).catch(e=>{});}if(audioDesbloqueado){document.removeEventListener('click',desbloquearAudio)}}
    async function mostrarNotificacao(evento){if(!configNotificacao.ativadas)return;if(!("Notification"in window))return;let p=Notification.permission;if(p==="granted"){tocarSomNotificacao();new Notification("Gerenciador",{body:`${evento.status} √†s ${evento.hora}`,tag:`gdp-${evento.hora}`})}else if(p==="default"){try{p=await Notification.requestPermission();if(p==="granted")mostrarNotificacao(evento)}catch(e){}}}
    
    function clicarElemento(s, t = null) {
        let e = null;
        if (t) {
            const l = document.querySelectorAll(s); 
            for (const o of l) {
                if (o.textContent.trim().toLowerCase() === t.toLowerCase()) {
                    e = o;
                    while (e && e.parentElement && e.tagName !== 'BUTTON') e = e.parentElement;
                    if (e && e.tagName === 'BUTTON') break; 
                    e = null;
                }
            }
        } else { e = document.querySelector(s); }
        
        if (e) {
            const c = new MouseEvent('click', { view: window, bubbles: true, cancelable: true });
            e.dispatchEvent(c);
            return true;
        }
        return false;
    }
    
    function clicarVoltarSubmenu(){if(clicarElemento(SELECTORES.VOLTAR_SUBMENU))return!0;return!1}
    function formatarDuracao(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),c=Math.max(0,s%60);const p=n=>String(n).padStart(2,'0');return`${p(h)}:${p(m)}:${p(c)}`}
    function converterDuracaoParaSegundos(d){if(!d||typeof d!=='string')return 0;const p=d.split(':');if(p.length!==3)return 0;const h=parseInt(p[0],10)||0,m=parseInt(p[1],10)||0,s=parseInt(p[2],10)||0;return(h*3600)+(m*60)+s}
    
    function registrarPausa(n){
        const a=new Date;
        if(estadoAtual.ativa){
            const f=a; const d=f.getTime()-estadoAtual.inicio.getTime();
            if(d>500){ 
                historicoPausas.push({
                    tipo:estadoAtual.tipo,
                    inicio:estadoAtual.inicio.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
                    fim:f.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
                    duracao:formatarDuracao(Math.round(d/1000))
                });
                renderizarHistoricoLog(); renderizarEstatisticas();
            }
        } 
        estadoAtual={ tipo:n, inicio:a, ativa: (n !== 'Logoff') };
        atualizarUI();
    }
    
    function adicionarAtalho(){document.addEventListener('keydown',function(e){const c=e.ctrlKey||e.metaKey,s=e.shiftKey,o=e.key==='1';if(document.activeElement&&['INPUT','TEXTAREA'].includes(document.activeElement.tagName))return;if(c&&s&&o){e.preventDefault();toggleVisibilidade()}})}

    // --- Agendamento ---
    function mapearEexecutarAcao(s){
        console.log(`[AGENDAMENTO] A√ß√£o Autom√°tica: ${s}`);
        const status = s.toLowerCase().trim();
        switch(status){
            case"na fila": iniciarNaFila(true); break;
            case"dispon√≠vel": voltarDisponivel(true); break;
            case"pausa out": iniciarPausaOut(true); break;
            case"pausa auricular": 
            case"pausa pessoal":
            case"descanso": iniciarDescanso(true); break;
            case"refei√ß√£o": iniciarRefeicao(true); break;
            case"treinamento": iniciarTreinamento(true); break;
            case"reuni√£o": iniciarReuniao(true); break;
            case"logoff": realizarLogoff(true); break;
            case"atividade backoffice":
            case"ativ. backoffice":
            case"backoffice": iniciarBackoffice(true); break;
            case"feedback": iniciarFeedback(true); break;
            case"particular": iniciarParticular(true); break;
            case"quest√µes de sa√∫de":
            case"sa√∫de":
            case"saude": iniciarQuestoesSaude(true); break;
            default: console.warn(`Status '${s}' desconhecido.`);
        }
    }
    
    function verificarEExecutarAgendamentos(){if(!isAgendamentoAtivo||isAutomacaoPausada)return; const a=new Date,h=`${String(a.getHours()).padStart(2,'0')}:${String(a.getMinutes()).padStart(2,'0')}`,s=a.getSeconds(); Object.keys(window).forEach(k=>{if(k.startsWith('notif_')){const e=k.split('_')[1];if(e<h){clearTimeout(window[k]);delete window[k];}}}); const eA=PAUSAS_AGENDADAS.find(p=>p.hora===h);if(eA && ultimoEventoProcessado !== h){mapearEexecutarAcao(eA.status);ultimoEventoProcessado = h;if(eA.status.toLowerCase()==='logoff'){setTimeout(()=>{if(isAgendamentoAtivo)toggleAgendamento()},500)}return} if(!eA && ultimoEventoProcessado) { ultimoEventoProcessado = null; } if (s < 15) {const pM=new Date(a.getTime()+6e4),hP=`${String(pM.getHours()).padStart(2,'0')}:${String(pM.getMinutes()).padStart(2,'0')}`;const eP=PAUSAS_AGENDADAS.find(p=>p.hora===hP);if(eP){const antecedencia = configNotificacao.antecedenciaSegundos; const sN=Math.max(0,(60-antecedencia)-s),tId=`notif_${eP.hora}_${eP.status}`;if(sN>0&&!window[tId]){window[tId]=setTimeout(()=>{mostrarNotificacao(eP);delete window[tId]},sN*1e3)}}}}
    function iniciarSchedulerSincronizado(){if(!isAgendamentoAtivo)return; verificarEExecutarAgendamentos();schedulerInterval=setInterval(verificarEExecutarAgendamentos,60000)}
    function sincronizarEIniciarScheduler(){if(schedulerInterval)clearInterval(schedulerInterval);if(syncTimeout)clearTimeout(syncTimeout);const sA=new Date().getSeconds();const dMs=(60-sA)*1000;syncTimeout=setTimeout(iniciarSchedulerSincronizado,dMs)}
    
    function toggleAgendamento(){
        const b=document.getElementById('btn-toggle-agendamento'),p=document.getElementById('btn-pause-resume-agendamento');
        if(isAgendamentoAtivo){
            if(schedulerInterval)clearInterval(schedulerInterval);if(syncTimeout)clearTimeout(syncTimeout);
            schedulerInterval=null;syncTimeout=null;isAgendamentoAtivo=!1;isAutomacaoPausada=!1;
            if(b){b.textContent="Ligar Automa√ß√£o";b.style.background = 'linear-gradient(135deg, #23a745, #2dc24f)';}
            if(p)p.style.display='none';
        }else{
            PAUSAS_AGENDADAS=carregarHorariosLocalStorage();
            ultimoEventoProcessado=null;isAutomacaoPausada=!1;isAgendamentoAtivo=!0;
            if(b){b.textContent="Desligar Automa√ß√£o";b.style.background = 'linear-gradient(135deg, #dc3545, #e84a5f)';}
            if(p){
                p.textContent="Pausar ‚è∏Ô∏è";p.style.background = 'linear-gradient(135deg, #ffc107, #ffd25a)';p.style.color = '#000';p.style.display='inline-block';
            }
            sincronizarEIniciarScheduler();
        }
    }
    function togglePausaAutomacao(){
        if(!isAgendamentoAtivo)return;
        isAutomacaoPausada=!isAutomacaoPausada;
        const b=document.getElementById('btn-pause-resume-agendamento');
        if(isAutomacaoPausada){
            if(b){b.textContent="Retomar ‚ñ∂Ô∏è";b.style.background = 'linear-gradient(135deg, #007FFF, #009cff)';b.style.color = '#fff';}
        }else{
            if(b){b.textContent="Pausar ‚è∏Ô∏è";b.style.background = 'linear-gradient(135deg, #ffc107, #ffd25a)';b.style.color = '#000';}
            verificarEExecutarAgendamentos();
        }
    }

    // --- Edi√ß√£o ---
    function adicionarNovoHorario(){const iH=document.getElementById('novo-horario-hora'),iS=document.getElementById('novo-horario-status');if(!iH||!iS)return;const h=iH.value,s=iS.value.trim();if(!h||!s)return;if(PAUSAS_AGENDADAS.some(p=>p.hora===h)){if(!confirm(`J√° existe ${h}. Substituir?`))return;PAUSAS_AGENDADAS=PAUSAS_AGENDADAS.filter(p=>p.hora!==h)}PAUSAS_AGENDADAS.push({hora:h,status:s});PAUSAS_AGENDADAS.sort((a,b)=>a.hora.localeCompare(b.hora));salvarHorariosLocalStorage(PAUSAS_AGENDADAS);iH.value='';iS.value='';renderizarAgendamentos();alert("Hor√°rio salvo! Reinicie a automa√ß√£o.")}
    function removerHorario(idx){if(idx<0||idx>=PAUSAS_AGENDADAS.length)return;if(confirm("Remover?")){PAUSAS_AGENDADAS.splice(idx,1);salvarHorariosLocalStorage(PAUSAS_AGENDADAS);renderizarAgendamentos();alert("Removido! Reinicie a automa√ß√£o.")}}
    function carregarHorarioParaEdicao(idx){if(idx<0||idx>=PAUSAS_AGENDADAS.length)return;const item=PAUSAS_AGENDADAS[idx];const iH=document.getElementById('novo-horario-hora'),iS=document.getElementById('novo-horario-status');if(!iH||!iS)return;iH.value=item.hora;iS.value=item.status;iS.focus();iS.select()}

    // --- Export/Import ---
    function exportarConfiguracoes(){try{const c={pausas:carregarHorariosLocalStorage(),notificacoes:carregarConfiguracoesNotificacaoLocalStorage(),posicoes:{main:carregarPosicaoPainelLocalStorage(STORAGE_KEY_POS_MAIN),config:carregarPosicaoPainelLocalStorage(STORAGE_KEY_POS_CONFIG)}};const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(c,null,2));const l=document.createElement('a');l.setAttribute('href',d);l.setAttribute('download','config_gerenciador_pausas.json');document.body.appendChild(l);l.click();l.remove();}catch(e){alert("Erro ao exportar.")}}
    function importarConfiguracoes(){const i=document.getElementById('import-file-input');if(i)i.click()}
    function handleArquivoImportado(event){const a=event.target.files[0];if(!a)return;const r=new FileReader();r.onload=function(e){try{const c=JSON.parse(e.target.result);if(c&&c.pausas){salvarHorariosLocalStorage(c.pausas);salvarConfiguracoesNotificacaoLocalStorage(c.notificacoes||NOTIF_CONFIG_DEFAULT);salvarPosicaoPainelLocalStorage(STORAGE_KEY_POS_MAIN,c.posicoes?.main);salvarPosicaoPainelLocalStorage(STORAGE_KEY_POS_CONFIG,c.posicoes?.config);alert("Importado com sucesso! Recarregue a p√°gina.");}}catch(err){alert("Arquivo inv√°lido.")}};r.readAsText(a)}

    // ----------------------------------------------------
    // L√ìGICA DE A√á√ÉO
    // ----------------------------------------------------
    const DELAY_ABRIR_MENU = 700; const DELAY_ABRIR_SUBMENU = 500; const DELAY_FECHAR_MENU = 200;
    
    function executarLogicaMenuSimples(seletorBotao, nomePausa, isAutomatico = false) {
        if (clicarElemento(SELECTORES.MENU_STATUS_TOGGLE)) {
            setTimeout(() => {
                if (!clicarElemento(seletorBotao)) {
                    console.warn(`[A√á√ÉO] Falha ao clicar ${nomePausa}.`);
                    clicarElemento(SELECTORES.MENU_STATUS_TOGGLE);
                }
            }, DELAY_ABRIR_MENU);
        }
    }
    
    function executarLogicaSubMenu(seletorMenuTexto, seletorItemTexto, nomePausa, isAutomatico = false) {
         if (clicarElemento(SELECTORES.MENU_STATUS_TOGGLE)) {
            setTimeout(() => {
                const seletorMenuBotao = SELECTORES.STATUS_LABEL_TEXT; 
                if (clicarElemento(seletorMenuBotao, seletorMenuTexto)) { 
                    setTimeout(() => {
                        if (clicarElemento(SELECTORES.STATUS_LABEL_TEXT, seletorItemTexto)) {
                             setTimeout(clicarVoltarSubmenu, DELAY_FECHAR_MENU);
                        } else {
                             clicarElemento(SELECTORES.VOLTAR_SUBMENU); 
                             setTimeout(clicarElemento, DELAY_FECHAR_MENU, SELECTORES.MENU_STATUS_TOGGLE);
                        }
                    }, DELAY_ABRIR_SUBMENU);
                } else {
                     clicarElemento(SELECTORES.MENU_STATUS_TOGGLE);
                }
            }, DELAY_ABRIR_MENU);
        }
    }

    function executarLogicaNaFila(isAutomatico = false) {
        let clicado = false; 
        let elDireto = document.querySelector(SELECTORES.NA_FILA_DIRETO);
        if (elDireto && elDireto.offsetHeight !== 0) {
            try{ elDireto.click(); clicado = true; } catch(e){ clicado = clicarElemento(SELECTORES.NA_FILA_DIRETO); }
        } else {
            try {
                const guxToggle = document.querySelector(SELECTORES.NA_FILA_TOGGLE_HOST);
                if (guxToggle && guxToggle.shadowRoot) {
                    const slider = guxToggle.shadowRoot.querySelector('div[role="checkbox"]'); 
                    if (slider) { slider.click(); clicado = true; } 
                }
            } catch (e) {}
        }
        if(!clicado) console.warn("A√ß√£o 'Na Fila' falhou.");
    }
    
    function executarLogicaRefeicao(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.REFEICAO, 'Refei√ß√£o', isAutomatico); }
    function executarLogicaDisponivel(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.DISPONIVEL, 'Dispon√≠vel', isAutomatico); }
    function executarLogicaTreinamento(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.TREINAMENTO, 'Treinamento', isAutomatico); }
    function executarLogicaReuniao(isAutomatico = false){ executarLogicaMenuSimples(SELECTORES.REUNIAO, 'Reuni√£o', isAutomatico); }
    function executarLogicaDescanso(isAutomatico = false){ executarLogicaSubMenu("Intervalo", "Pausa auricular", "Pausa auricular", isAutomatico); }
    function executarLogicaPausaOut(isAutomatico = false){ executarLogicaSubMenu("Ocupado", "Pausa out", "Pausa out", isAutomatico); }
    function executarLogicaBackoffice(isAutomatico = false){ executarLogicaSubMenu("Ocupado", "Atividade backoffice", "Backoffice", isAutomatico); }
    function executarLogicaFeedback(isAutomatico = false){ executarLogicaSubMenu("Ocupado", "Feedback", "Feedback", isAutomatico); }
    function executarLogicaParticular(isAutomatico = false){ executarLogicaSubMenu("Ausente", "Particular", "Particular", isAutomatico); }
    function executarLogicaQuestoesSaude(isAutomatico = false){ executarLogicaSubMenu("Ausente", "Quest√µes de sa√∫de", "Sa√∫de", isAutomatico); }

    function executarLogicaLogoff(isAutomatico = false) {
        if (!isAutomatico && !confirm("Fazer logoff? Hist√≥rico ser√° zerado.")) return;
        if (clicarElemento(SELECTORES.MENU_STATUS_TOGGLE)) {
            setTimeout(() => {
                if (clicarElemento(SELECTORES.LOGOFF, "Fazer logoff")) {
                    historicoPausas=[];
                    estadoAtual={tipo:'Logoff',inicio:new Date,ativa:!1};
                    atualizarUI();renderizarHistoricoLog();renderizarEstatisticas();
                    if(isAgendamentoAtivo) toggleAgendamento();
                } else {
                    clicarElemento(SELECTORES.MENU_STATUS_TOGGLE);
                }
            }, DELAY_ABRIR_MENU);
        }
    }

    // ======================================================
    // ORQUESTRADORES
    // ======================================================

    function iniciarNaFila(isAutomatico = false){ registrarPausa("Na fila"); executarLogicaNaFila(isAutomatico); }
    function iniciarRefeicao(isAutomatico = false){ registrarPausa("Refei√ß√£o"); executarLogicaRefeicao(isAutomatico); }
    function voltarDisponivel(isAutomatico = false){ registrarPausa("Dispon√≠vel"); executarLogicaDisponivel(isAutomatico); }
    function iniciarTreinamento(isAutomatico = false){ registrarPausa("Treinamento"); executarLogicaTreinamento(isAutomatico); }
    function iniciarReuniao(isAutomatico = false){ registrarPausa("Reuni√£o"); executarLogicaReuniao(isAutomatico); }
    function iniciarDescanso(isAutomatico = false){ registrarPausa("Pausa auricular"); executarLogicaDescanso(isAutomatico); }
    function iniciarPausaOut(isAutomatico = false){ registrarPausa("Pausa out"); executarLogicaPausaOut(isAutomatico); }
    function iniciarBackoffice(isAutomatico = false){ registrarPausa("Backoffice"); executarLogicaBackoffice(isAutomatico); }
    function iniciarFeedback(isAutomatico = false){ registrarPausa("Feedback"); executarLogicaFeedback(isAutomatico); }
    function iniciarParticular(isAutomatico = false){ registrarPausa("Particular"); executarLogicaParticular(isAutomatico); }
    function iniciarQuestoesSaude(isAutomatico = false){ registrarPausa("Sa√∫de"); executarLogicaQuestoesSaude(isAutomatico); }
    function realizarLogoff(isAutomatico = false){ executarLogicaLogoff(isAutomatico); }

    // ----------------------------------------------------
    // UI, ARRASTE GPU + IFRAME FIX (V51.1)
    // ----------------------------------------------------
    
    // Fun√ß√£o utilit√°ria para criar o Overlay de prote√ß√£o contra Iframes
    function criarDragOverlay() {
        if(document.getElementById('pausa-script-drag-overlay')) return;
        const o = document.createElement('div');
        o.id = 'pausa-script-drag-overlay';
        o.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:none;cursor:grabbing;';
        document.body.appendChild(o);
        return o;
    }
// =======================================================
    // NOVO SISTEMA DE ARRASTE ‚Äî V51.1 (FLUIDO + IN√âRCIA)
    // =======================================================
    function setupGPUDrag(elementId, headerId, storageKey) {
        const element = document.getElementById(elementId);
        const header = document.getElementById(headerId);
        const icone = document.getElementById('pausa-script-icone');
        const overlay = document.getElementById('pausa-script-drag-overlay');

        if (!element || !header || !overlay) return;

        let dragging = false;
        let startX = 0, startY = 0;
        let initialLeft = 0, initialTop = 0;
        let lastClientX = 0, lastClientY = 0;
        let lastTime = 0;
        let velX = 0, velY = 0;
        let transX = 0, transY = 0;
        let moved = false;

        const MOVE_THRESHOLD = 6;
        const FRICTION = 0.90;
        const MIN_SPEED = 0.25;

        function disableSelection(flag) {
            document.body.style.userSelect = flag ? "none" : "";
            document.body.style.touchAction = flag ? "none" : "";
        }

        function applyTransform() {
            element.style.transform = `translate(${transX}px, ${transY}px)`;
        }

        function getBoundedPosition(x, y) {
            const maxX = window.innerWidth - element.offsetWidth;
            const maxY = window.innerHeight - element.offsetHeight;

            return {
                x: Math.max(0, Math.min(x, maxX)),
                y: Math.max(0, Math.min(y, maxY))
            };
        }

        function onPointerDown(e) {
            const isHeader = header.contains(e.target);
            const isIcon = (icone && icone.contains(e.target));

            if (!isHeader && !isIcon) return;

            dragging = true;
            moved = false;

            startX = e.clientX;
            startY = e.clientY;

            lastClientX = e.clientX;
            lastClientY = e.clientY;
            lastTime = performance.now();

            const rect = element.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;

            element.style.transition = "none";
            element.style.left = initialLeft + "px";
            element.style.top = initialTop + "px";
            element.style.transform = "none";

            overlay.style.display = "block";
            disableSelection(true);

            document.addEventListener("pointermove", onPointerMove, { passive: false });
            document.addEventListener("pointerup", onPointerUp, { passive: false });
            document.addEventListener("pointercancel", onPointerUp, { passive: false });
        }

        function onPointerMove(e) {
            if (!dragging) return;
            e.preventDefault();

            const now = performance.now();
            const dt = now - lastTime;

            const dx = e.clientX - lastClientX;
            const dy = e.clientY - lastClientY;

            velX = dx / dt * 16.6;
            velY = dy / dt * 16.6;

            lastClientX = e.clientX;
            lastClientY = e.clientY;
            lastTime = now;

            const totalDX = e.clientX - startX;
            const totalDY = e.clientY - startY;

            if (!moved && (Math.abs(totalDX) > MOVE_THRESHOLD || Math.abs(totalDY) > MOVE_THRESHOLD)) {
                moved = true;
            }

            transX = totalDX;
            transY = totalDY;

            applyTransform();
        }

        function animateInertia() {
            velX *= FRICTION;
            velY *= FRICTION;

            transX += velX;
            transY += velY;

            const newLeft = initialLeft + transX;
            const newTop = initialTop + transY;

            const bounded = getBoundedPosition(newLeft, newTop);

            element.style.left = bounded.x + "px";
            element.style.top = bounded.y + "px";

            element.style.transform = "none";

            if (Math.abs(velX) > MIN_SPEED || Math.abs(velY) > MIN_SPEED) {
                requestAnimationFrame(animateInertia);
            } else {
                salvarPosicaoPainelLocalStorage(storageKey, element);
                overlay.style.display = "none";
                disableSelection(false);

                globalWasDragging = moved;
                setTimeout(() => globalWasDragging = false, 150);
            }
        }

        function onPointerUp() {
            if (!dragging) return;
            dragging = false;

            document.removeEventListener("pointermove", onPointerMove);
            document.removeEventListener("pointerup", onPointerUp);
            document.removeEventListener("pointercancel", onPointerUp);

            if (!moved) {
                overlay.style.display = "none";
                disableSelection(false);
                globalWasDragging = false;
                return;
            }

            animateInertia();
        }

        header.addEventListener("pointerdown", onPointerDown);
        if (icone) icone.addEventListener("pointerdown", onPointerDown);
    }

    function toggleVisibilidade() {
        const c=document.getElementById('pausa-script-container'),o=document.getElementById('pausa-script-conteudo'),i=document.getElementById('pausa-script-icone');
        if(!c||!o||!i)return;
        const m=15;
        if (o.style.display !== 'none') {
            o.style.display = 'none'; i.style.display = 'flex';
            c.style.width = 'auto'; c.style.padding = '5px 12px'; c.style.cursor = 'grab'; c.style.fontFamily = "'Courier New', Courier, monospace"; 
            c.style.background='linear-gradient(145deg, rgba(20,25,35,0.9), rgba(30,35,50,0.95))'; 
        } else {
            o.style.display = 'block'; i.style.display = 'none';
            const lE = 300; c.style.width = lE + 'px'; c.style.padding = '15px'; c.style.cursor = 'default'; c.style.fontFamily = "'Segoe UI',Tahoma,Geneva,Verdana,sans-serif"; 
            c.style.background='linear-gradient(145deg, rgba(25,30,40,0.9), rgba(35,40,55,0.95))'; 
            const h = c.querySelector('#pausa-script-header'); if (h) h.style.cursor = 'move';
            if(c.style.top&&c.style.left){let cT=parseInt(c.style.top,10),cL=parseInt(c.style.left,10);setTimeout(()=>{const hE=c.offsetHeight;const mL=window.innerWidth-lE-m;if(cL>mL){c.style.left=mL+'px'}if(cL<m){c.style.left=m+'px'}const mT=window.innerHeight-hE-m;if(cT>mT){c.style.top=mT+'px'}if(cT<m){c.style.top=m+'px'}},10)}
            else { const r=c.getBoundingClientRect();c.style.left=r.left+'px';c.style.top=r.top+'px';c.style.bottom = ''; c.style.right = ''; }
        }
    }
    
    function toggleVisibilidadeConfig(){const c=document.getElementById('pausa-script-config-container');if(!c)return;isConfigPainelAberto=!isConfigPainelAberto;c.style.display=isConfigPainelAberto?'block':'none';if(isConfigPainelAberto){renderizarAgendamentos();renderizarHistoricoLog();renderizarEstatisticas()}}
    function renderizarAgendamentos(){const l=document.getElementById('agendamento-lista');if(!l)return; l.innerHTML='';if(PAUSAS_AGENDADAS.length===0){l.innerHTML='<p style="color:#999;margin:5px 0;font-size:11px;text-align:center;">Nenhum hor√°rio agendado.</p>'}else{const r=document.createDocumentFragment();PAUSAS_AGENDADAS.forEach((p,idx)=>{const i=document.createElement('div');i.style.cssText=`display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed #ffffff15;padding:4px 2px;font-size:11px;`;const tD=document.createElement('div');tD.style.flexGrow='1';tD.innerHTML=`<strong>${p.hora}</strong>: ${p.status}`;const bD=document.createElement('div');bD.style.flexShrink='0';bD.style.marginLeft='10px'; const bE=document.createElement('button');bE.innerHTML='‚úèÔ∏è';bE.title=`Editar ${p.hora}`;bE.style.cssText=`background:0 0;border:none;color:#ffc107;cursor:pointer;font-size:14px;padding:0 4px;opacity:.7;transition:opacity .2s;`;bE.onmouseover=function(){this.style.opacity='1'};bE.onmouseout=function(){this.style.opacity='.7'};bE.onclick=()=>carregarHorarioParaEdicao(idx); const bR=document.createElement('button');bR.innerHTML='‚ùå';bR.title=`Remover ${p.hora}`;bR.style.cssText=`background:0 0;border:none;color:#ff6b6b;cursor:pointer;font-size:14px;padding:0 4px;margin-left:5px;opacity:.7;transition:opacity .2s`;bR.onmouseover=function(){this.style.opacity='1'};bR.onmouseout=function(){this.style.opacity='.7'};bR.onclick=()=>removerHorario(idx); bD.appendChild(bE);bD.appendChild(bR);i.appendChild(tD);i.appendChild(bD);r.appendChild(i)});l.appendChild(r)}}
function renderizarHistoricoLog(){const l=document.getElementById('historico-log');if(!l)return; l.innerHTML='';if(historicoPausas.length===0){l.innerHTML='<p style="color:#999;margin:5px 0;font-size:11px;">Nenhum registro.</p>';return} const f=document.createDocumentFragment();historicoPausas.slice().reverse().forEach(p=>{const i=document.createElement('div');i.style.cssText=`border-bottom:1px dashed #ffffff15;padding:4px 0;font-size:11px;line-height:1.4;`;i.innerHTML=`<strong>${p.tipo}</strong>: ${p.inicio} √†s ${p.fim} <span style="color:#00b0ff;">(Dur: ${p.duracao})</span>`;f.appendChild(i)});l.appendChild(f);}
    function renderizarEstatisticas(){const s=document.getElementById('estatisticas-pausas');if(!s)return; s.innerHTML='';if(historicoPausas.length===0){s.innerHTML='<p style="color:#999;font-style:italic;margin:5px 0;font-size:11px;">Sem estat√≠sticas.</p>';return} const r={};historicoPausas.forEach(p=>{const t=p.tipo;if(!r[t])r[t]={c:0,s:0};r[t].c++;r[t].s+=converterDuracaoParaSegundos(p.duracao)}); const d=document.createElement('details');d.style.marginTop='10px';d.open=!0; const m=document.createElement('summary');m.style.cssText='cursor:pointer;color:#00b0ff;font-weight:700;margin-bottom:5px;';m.textContent='Estat√≠sticas';d.appendChild(m); const c=document.createElement('div');c.style.cssText=`background-color:#00000040;padding:8px;border-radius:8px;font-size:11px;`; const f=document.createDocumentFragment();const k=Object.keys(r).sort();k.forEach((t,x)=>{const o=r[t];const u=formatarDuracao(o.s);const i=document.createElement('div');i.style.cssText=`display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px dashed #ffffff15;line-height:1.4;`;if(x===k.length-1)i.style.borderBottom='none';i.innerHTML=`<strong>${t} (x${o.c})</strong> <span style="color:#00b0ff;">${u}</span>`;f.appendChild(i)}); c.appendChild(f);d.appendChild(c);s.appendChild(d);}
    function verificarSeletoresEAtualizarUI(){const rD=document.getElementById('seletores-resultados'); if(!rD)return; rD.innerHTML='<p style="font-style:italic;color:#bbb;">Verificando...</p>'; let hR='<ul style="list-style:none;padding:0;margin:5px 0 0 0;font-size:11px;">';setTimeout(()=>{Object.keys(SELECTORES).forEach(k=>{const s=SELECTORES[k]; const e=document.querySelector(s);const f=e!==null&&(e.offsetParent!==null||e.tagName==='DIV'||e.tagName==='SPAN'); hR+=`<li style="padding:3px 0;border-bottom:1px dashed #ffffff15;display:flex;justify-content:space-between;align-items:center;"><span style="color:#ccc; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${k}:</span><span><code style="font-size:10px;background-color:rgba(0,255,255,.1);border:1px solid rgba(0,255,255,.2);color:#9fefef;padding:1px 3px;border-radius:3px; max-width: 120px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s}</code><span style="margin-left:8px;font-weight:700;color:${f?'#50fa7b':'#ff5555'};">${f?'Ok':'Fail'}</span></span></li>`;});hR+='</ul>';rD.innerHTML=hR},50)}

    // --- CRIAR UI PRINCIPAL ---
    function criarUI() {
        const cId='pausa-script-container';let cA=document.getElementById(cId);if(cA)cA.remove(); 
        const c=document.createElement('div');c.id=cId;document.body.appendChild(c);

        const pS=carregarPosicaoPainelLocalStorage(STORAGE_KEY_POS_MAIN);
        let cssPos = `position:fixed; ${pS ? (pS.top ? `top:${pS.top};left:${pS.left};` : `bottom:${pS.bottom};right:${pS.right};`) : 'bottom:30px;right:30px;'}`;

        c.style.cssText = `${cssPos} width:auto;height:auto;color:#E0E0E0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;padding:5px 12px;border-radius:10px;border:1px solid rgba(0,255,255,0.3);background:linear-gradient(145deg,rgba(20,25,35,0.9),rgba(30,35,50,0.95));box-shadow:0 8px 20px rgba(0,0,0,0.5),0 0 10px rgba(0,255,255,0.1);backdrop-filter:blur(10px);z-index:2147483647;cursor:grab;user-select:none;transition:box-shadow .2s;box-sizing:border-box;will-change:transform;`;

        c.innerHTML=`
            <div id="pausa-script-icone" style="display:flex;">
                <span id="pausa-script-clock-dot" style="display:none;"></span>
                <span id="top-bar-time">--:--:--</span>
            </div>
            <div id="pausa-script-conteudo" style="display:none;padding:0;">
                <div id="pausa-script-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0;color:#0FF;font-size:16px;">Gerenciador</h3>
                    <div style="display:flex;gap:10px;">
                        <span id="pausa-script-header-clock" style="font-size:15px;color:#f1fa8c;">--:--:--</span>
                        <span id="btn-abrir-config" style="cursor:pointer;">‚öôÔ∏è</span>
                        <span id="btn-minimizar" style="cursor:pointer;color:#ff5555">[X]</span>
                    </div>
                </div>

                <div id="status-display">Status: <strong id="current-status" style="color:#50fa7b;">Dispon√≠vel</strong></div>

                <button id="btn-toggle-agendamento" class="script-btn">Ligar Automa√ß√£o</button>
                <button id="btn-pause-resume-agendamento" class="script-btn" style="display:none;">Pausar ‚è∏Ô∏è</button>

                <div id="buttons-container">
                    <button id="btn-disponivel" class="script-btn">üü¢ Dispon√≠vel</button>
                    <button id="btn-na-fila" class="script-btn">üéß Na Fila</button>
                    <button id="btn-refeicao" class="script-btn">üçî Refei√ß√£o</button>
                    <button id="btn-descanso" class="script-btn">‚òï Pausa auricular</button>
                    <button id="btn-pausa-out" class="script-btn">‚õî Pausa Out</button>
                    <button id="btn-treinamento" class="script-btn">üìö Treinamento</button>
                    <button id="btn-backoffice" class="script-btn">üìÅ Backoffice</button>
                    <button id="btn-feedback" class="script-btn">üìù Feedback</button>
                    <button id="btn-particular" class="script-btn">üîí Particular</button>
                    <button id="btn-saude" class="script-btn">ü©∫ Sa√∫de</button>
                </div>

                <div id="buttons-extra">
                    <button id="btn-reuniao" class="script-btn">üßë‚Äçü§ù‚Äçüßë Reuni√£o</button>
                    <button id="btn-logoff" class="script-btn">üö™ Fazer Logoff</button>
                </div>
            </div>
        `;

        criarDragOverlay();
        setupGPUDrag('pausa-script-container', 'pausa-script-header', STORAGE_KEY_POS_MAIN);

        c.addEventListener('click',function(e){
            if (globalWasDragging) return;
            const t=e.target.closest('button'),n=e.target.closest('span#btn-minimizar, span#btn-abrir-config'),o=e.target.closest('div#pausa-script-icone');
            if(!t&&!n&&!o)return;

            const d=document.getElementById('pausa-script-conteudo');
            if(o && d && d.style.display==='none'){ toggleVisibilidade(); return; }

            let id = (t||n||o).id;
            switch(id){
                case'btn-na-fila':iniciarNaFila(false);break; 
                case'btn-refeicao':iniciarRefeicao(false);break;
                case'btn-descanso':iniciarDescanso(false);break; 
                case'btn-pausa-out':iniciarPausaOut(false);break;
                case'btn-disponivel':voltarDisponivel(false);break; 
                case'btn-logoff':realizarLogoff(false);break;
                case'btn-treinamento':iniciarTreinamento(false);break; 
                case'btn-reuniao':iniciarReuniao(false);break;
                case'btn-backoffice':iniciarBackoffice(false);break;
                case'btn-feedback':iniciarFeedback(false);break;
                case'btn-particular':iniciarParticular(false);break;
                case'btn-saude':iniciarQuestoesSaude(false);break;
                case'btn-toggle-agendamento':toggleAgendamento();break; 
                case'btn-pause-resume-agendamento':togglePausaAutomacao();break;
                case'btn-minimizar':toggleVisibilidade();break; 
                case'btn-abrir-config':toggleVisibilidadeConfig();break;
            }
        });

        registrarPausa(estadoAtual.tipo); 
        adicionarAtalho(); 
        setInterval(atualizarUI,1000);
    }

    // --- UI CONFIGURA√á√ïES ---
    function criarUIConfiguracoes() {
        const cId='pausa-script-config-container';
        let old=document.getElementById(cId);
        if(old) old.remove();

        const cC=document.createElement('div');
        cC.id=cId;
        document.body.appendChild(cC);

        cC.style.cssText="position:fixed;bottom:30px;right:340px;width:340px;background:#1b1f29;color:#fff;padding:15px;border-radius:10px;z-index:2147483646;display:none;max-height:80vh;overflow-y:auto";

        cC.innerHTML=`
            <div style="display:flex;justify-content:space-between;">
                <h3>Configura√ß√µes</h3>
                <span id="btn-fechar-config" style="cursor:pointer;color:#ff5555">[X]</span>
            </div>

            <details open>
                <summary>Estat√≠sticas</summary>
                <div id="estatisticas-pausas"></div>
            </details>

            <details open>
                <summary>Hor√°rios</summary>
                <div id="agendamento-lista"></div>
                <input type="time" id="novo-horario-hora">
                <input type="text" id="novo-horario-status">
                <button id="btn-adicionar-horario">Adicionar</button>
            </details>

            <details>
                <summary>Hist√≥rico</summary>
                <div id="historico-log"></div>
            </details>

            <details>
                <summary>Diagn√≥stico</summary>
                <button id="btn-verificar-seletores">Verificar</button>
                <div id="seletores-resultados"></div>
            </details>
        `;

        setupGPUDrag('pausa-script-config-container', cC, STORAGE_KEY_POS_CONFIG);

        cC.querySelector('#btn-fechar-config').onclick = toggleVisibilidadeConfig;
        cC.querySelector('#btn-adicionar-horario').onclick = adicionarNovoHorario;
        cC.querySelector('#btn-verificar-seletores').onclick = verificarSeletoresEAtualizarUI;

        renderizarAgendamentos();
        renderizarHistoricoLog();
        renderizarEstatisticas();
    }

    // --- ATUALIZA√á√ÉO DE UI ---
    function atualizarUI() {
        const now=new Date();
        const h=now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

        const tFlutuante=document.getElementById('top-bar-time');
        const tHeader=document.getElementById('pausa-script-header-clock');

        if(tFlutuante) tFlutuante.textContent=h;
        if(tHeader) tHeader.textContent=h;

        const s=document.getElementById('current-status');
        if(s){
            let extra="";
            if(estadoAtual.ativa){
                const d=Math.floor((now-estadoAtual.inicio)/1000);
                extra=` (${formatarDuracao(d)})`;
            }
            s.textContent = estadoAtual.tipo + extra;
        }
    }

    // --- START ---
    console.log("[GERENCIADOR V51.1] Iniciando...");
    setTimeout(() => {
        try {
            configNotificacao = carregarConfiguracoesNotificacaoLocalStorage();
            PAUSAS_AGENDADAS = carregarHorariosLocalStorage();

            criarUI();
            criarUIConfiguracoes();
            renderizarAgendamentos();

            document.addEventListener('click', desbloquearAudio, { once:true });

        } catch (e) { console.error("[GERENCIADOR] Erro:", e); }
    }, 1200);

})();

















































/        currentTranslateY = totalDY;
        scheduleTransform();
    }

    function startInertiaAnimation() {
        // Use a simple friction loop for inertia
        function step() {
            // apply velocity
            currentTranslateX += velocityX;
            currentTranslateY += velocityY;

            // apply friction
            velocityX *= FRICTION;
            velocityY *= FRICTION;

            // boundary check: if element would go out of viewport, clamp and reduce velocity
            let left = initialLeft + currentTranslateX;
            let top = initialTop + currentTranslateY;
            const bounds = getBoundedPosition(left, top);
            if (left < bounds.boundedLeft) {
                left = bounds.boundedLeft;
                currentTranslateX = left - initialLeft;
                velocityX = -velocityX * 0.4;
            } else if (left > bounds.boundedLeft) {
                // nothing
            }
            if (top < bounds.boundedTop) {
                top = bounds.boundedTop;
                currentTranslateY = top - initialTop;
                velocityY = -velocityY * 0.4;
            } else if (top > bounds.boundedTop) {
                // nothing
            }

            element.style.transform = `translate3d(${currentTranslateX}px, ${currentTranslateY}px, 0)`;

            const speed = Math.hypot(velocityX, velocityY);
            if (speed > MIN_VELOCITY) {
                requestAnimationFrame(step);
            } else {
                // finalize position and save
                const finalLeft = Math.round(initialLeft + currentTranslateX);
                const finalTop = Math.round(initialTop + currentTranslateY);
                const finalBounds = getBoundedPosition(finalLeft, finalTop);

                // Snap to edges with small margin
                const margin = 12;
                let snapLeft = finalBounds.boundedLeft;
                let snapTop = finalBounds.boundedTop;

                // If close to edges, snap to them
                if (Math.abs(finalLeft - 0) < margin) snapLeft = 0;
                if (Math.abs(finalTop - 0) < margin) snapTop = 0;
                if (Math.abs(finalLeft - (window.innerWidth - element.offsetWidth)) < margin) snapLeft = window.innerWidth - element.offsetWidth;
                if (Math.abs(finalTop - (window.innerHeight - element.offsetHeight)) < margin) snapTop = window.innerHeight - element.offsetHeight;

                element.style.transition = 'left 160ms ease-out, top 160ms ease-out';
                element.style.transform = '';
                element.style.left = snapLeft + 'px';
                element.style.top = snapTop + 'px';

                // small timeout to allow transition to end then remove transition style
                setTimeout(() => { element.style.transition = ''; }, 200);

                // Persist position
                salvarPosicaoPainelLocalStorage(storageKey, element);

                // reset cursors
                element.style.cursor = 'default';
                if (header) header.style.cursor = 'move';
                if (icone && document.getElementById('pausa-script-conteudo') && document.getElementById('pausa-script-conteudo').style.display === 'none') {
                    element.style.cursor = 'grab';
                }

                // clear overlay & selection lock
                overlay.style.display = 'none';
                setUserSelectNone(false);

                // set global dragging flag for small time to avoid click
                if (hasMovedSignificantly) {
                    globalWasDragging = true;
                    setTimeout(() => { globalWasDragging = false; }, 120);
                }
            }
        }
        requestAnimationFrame(step);
    }

    function onPointerUp(e) {
        if (!dragging) return;

        dragging = false;

        // release pointer capture
        if (e.pointerId && element.releasePointerCapture) {
            try { element.releasePointerCapture(e.pointerId); } catch (err) { /* ignore */ }
        }

        // stop listening
        document.removeEventListener('pointermove', onPointerMove, { passive: false });
        document.removeEventListener('pointerup', onPointerUp, { passive: false });
        document.removeEventListener('pointercancel', onPointerUp, { passive: false });

        // hide overlay only after inertia ends
        overlay.style.display = 'block'; // keep while inertia runs

        // compute final velocities (already computed during move)
        // if small movement -> treat as click (no move)
        const totalDX = e.clientX - startX;
        const totalDY = e.clientY - startY;
        if (!hasMovedSignificantly && Math.abs(totalDX) < MOVE_THRESHOLD && Math.abs(totalDY) < MOVE_THRESHOLD) {
            // no real drag -> simply restore transform and allow click
            element.style.transform = '';
            overlay.style.display = 'none';
            setUserSelectNone(false);
            element.style.cursor = 'default';
            if (header) header.style.cursor = 'move';
            // small guard to avoid immediate click (but preserve normal click)
            globalWasDragging = false;
            return;
        }

        // else start inertia animation (may be tiny if velocities are small)
        startInertiaAnimation();
    }

    // Attach pointerdown (better than mousedown for touch support)
    header.addEventListener('pointerdown', onPointerDown);
    if (icone) icone.addEventListener('pointerdown', onPointerDown);

    // Accessibility: keyboard move with arrow keys + modifier (optional)
    element.addEventListener('keydown', function(ev) {
        if (document.activeElement !== element) return;
        const step = ev.shiftKey ? 20 : 6;
        let moved = false;
        if (ev.key === 'ArrowLeft') { element.style.left = (parseInt(element.style.left || element.getBoundingClientRect().left,10) - step) + 'px'; moved = true; }
        if (ev.key === 'ArrowRight') { element.style.left = (parseInt(element.style.left || element.getBoundingClientRect().left,10) + step) + 'px'; moved = true; }
        if (ev.key === 'ArrowUp') { element.style.top = (parseInt(element.style.top || element.getBoundingClientRect().top,10) - step) + 'px'; moved = true; }
        if (ev.key === 'ArrowDown') { element.style.top = (parseInt(element.style.top || element.getBoundingClientRect().top,10) + step) + 'px'; moved = true; }
        if (moved) {
            ev.preventDefault();
            element.style.transition = 'left 80ms linear, top 80ms linear';
            setTimeout(()=>{ element.style.transition = ''; salvarPosicaoPainelLocalStorage(storageKey, element); }, 120);
        }
    });

    // ensure element can receive focus for keyboard dragging
    element.setAttribute('tabindex', '0');
}



































// =================================================================
// GERENCIADOR PAUSAS - V51.2 (OTIMIZADO PARA GENESYS - BRISANET)
// Apenas arraste e mecanismo de clique/agendamento otimizados.
// Cole as 3 partes em sequ√™ncia no Tampermonkey.
// =================================================================
(function(){
/* ---------- CONFIG / STATE ---------- */
const SELECTORES = {
  MENU_STATUS_TOGGLE: '#toggleUserDropdownTarget',
  DISPONIVEL: 'button.presence-available',
  REFEICAO: 'button.presence-meal',
  INTERVALO_MENU: 'button.presence-break',
  OCUPADO_MENU: 'button.presence-busy',
  LOGOFF: 'span.menu-label',
  NA_FILA_TOGGLE_HOST: 'gux-toggle#command-bar-queue-toggle',
  NA_FILA_DIRETO: 'gux-button.onQueueButton',
  VOLTAR_SUBMENU: 'button[title="Volte √†s presen√ßas prim√°rias"]',
  STATUS_LABEL_TEXT: 'span.presence-label-text',
  TREINAMENTO: 'button.presence-training',
  REUNIAO: 'button.presence-meeting'
};
const PAUSAS_AGENDADAS_DEFAULT = [
  {hora:"17:40",status:"Na fila"},{hora:"18:35",status:"Pausa out"},{hora:"18:40",status:"Pausa auricular"},
  {hora:"18:50",status:"Na fila"},{hora:"19:45",status:"Pausa out"},{hora:"19:50",status:"Refei√ß√£o"},
  {hora:"20:10",status:"Na fila"},{hora:"22:25",status:"Pausa out"},{hora:"22:30",status:"Pausa auricular"},
  {hora:"22:40",status:"Na fila"},{hora:"00:00",status:"Logoff"}
];

const STORAGE = {
  PAUSAS: 'gerenciadorPausas_horarios',
  POS_MAIN: 'gerenciadorPausas_posMain',
  POS_CFG: 'gerenciadorPausas_posConfig',
  NOTIF: 'gerenciadorPausas_notifConfig'
};

let estadoAtual = {tipo:'Dispon√≠vel',inicio:new Date(),ativa:false};
let historicoPausas = [];
let PAUSAS_AGENDADAS = load(STORAGE.PAUSAS) || PAUSAS_AGENDADAS_DEFAULT.slice();
let isAgendamentoAtivo=false, isAutomacaoPausada=false, schedulerInterval=null, syncTimeout=null, ultimoEventoProcessado=null;
let globalWasDragging=false;
let configNotificacao = load(STORAGE.NOTIF) || {ativadas:true,somAtivado:false,antecedenciaSegundos:15};
let audioNotificacao = new Audio('https://www.soundjay.com/button/sounds/beep-07a.mp3');
audioNotificacao.volume = 0.5;
let audioDesbloqueado=false;

/* ---------- UTIL ---------- */
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function load(k){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):null }catch(e){return null} }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function formatDur(s){ const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), c=Math.max(0,s%60); const p=n=>String(n).padStart(2,'0'); return `${p(h)}:${p(m)}:${p(c)}` }
function secFromHMS(d){ if(!d||typeof d!=='string') return 0; const p=d.split(':'); if(p.length!==3) return 0; return (parseInt(p[0],10)||0)*3600 + (parseInt(p[1],10)||0)*60 + (parseInt(p[2],10)||0); }

/* ---------- NOTIFICA√á√ÉO E SOM ---------- */
function desbloquearAudio(){ if(audioDesbloqueado) return; audioNotificacao.play().then(()=>{ audioNotificacao.pause(); audioNotificacao.currentTime=0; audioDesbloqueado=true; }).catch(()=>{}); document.removeEventListener('click',desbloquearAudio); }
function tocarSom(){ if(!configNotificacao.somAtivado) return; if(!audioDesbloqueado){ document.addEventListener('click', desbloquearAudio, {once:true}); return; } audioNotificacao.currentTime=0; audioNotificacao.play().catch(()=>{}); }
async function mostrarNotificacao(ev){ if(!configNotificacao.ativadas) return; if(!("Notification" in window)) return; if(Notification.permission==='granted'){ tocarSom(); new Notification("Gerenciador",{body:`${ev.status} √†s ${ev.hora}`}); } else if(Notification.permission==='default'){ try{ const p=await Notification.requestPermission(); if(p==='granted') mostrarNotificacao(ev); }catch(e){} } }

/* ---------- ROBUST CLICK ENGINE (shadow DOM + retries) ---------- */
/*
 - clicarRobustoSync(selector, text) -> boolean
 - tenta localizar em shadowRoots tamb√©m
 - faz at√© N tentativas com pequenos delays
*/
function queryAllDeep(selector){
  // busca simples + shadow root crawl (profundidade limitada)
  const results = Array.from(document.querySelectorAll(selector));
  // crawl simples: procurar em shadow roots de elementos comuns (Hosts)
  const hosts = Array.from(document.querySelectorAll('*')).filter(n=>n.shadowRoot);
  for(const h of hosts){
    try{
      const inner = h.shadowRoot.querySelectorAll(selector);
      if(inner && inner.length) results.push(...Array.from(inner));
    }catch(e){}
  }
  return results;
}
function tryDispatchClick(el){
  if(!el) return false;
  try{ if(typeof el.click==='function'){ el.click(); return true; } }catch(e){}
  try{
    const d1=new MouseEvent('mousedown',{bubbles:true,cancelable:true,composed:true});
    const d2=new MouseEvent('mouseup',{bubbles:true,cancelable:true,composed:true});
    const d3=new MouseEvent('click',{bubbles:true,cancelable:true,composed:true});
    el.dispatchEvent(d1); el.dispatchEvent(d2); el.dispatchEvent(d3);
    return true;
  }catch(e){}
  try{
    const p1=new PointerEvent('pointerdown',{bubbles:true,cancelable:true});
    const p2=new PointerEvent('pointerup',{bubbles:true,cancelable:true});
    const p3=new PointerEvent('click',{bubbles:true,cancelable:true});
    el.dispatchEvent(p1); el.dispatchEvent(p2); el.dispatchEvent(p3);
    return true;
  }catch(e){}
  return false;
}
function findByText(selector, text){
  const nodes = queryAllDeep(selector);
  text = (text||'').toString().trim().toLowerCase();
  for(const n of nodes){
    if((n.textContent||'').trim().toLowerCase()===text){
      // preferir elemento bot√£o pai
      let el=n;
      while(el && el.tagName !== 'BUTTON' && el.parentElement) el = el.parentElement;
      return el || n;
    }
  }
  return null;
}
function clicarRobustoSync(selector, text=null, attempts=5, delayMs=220){
  // tentativas s√≠ncronas simples (n√£o-blocking long) - retorna boolean
  let ok=false;
  for(let i=0;i<attempts;i++){
    let el = text ? findByText(selector,text) : (document.querySelector(selector) || queryAllDeep(selector)[0]);
    if(el){
      ok = tryDispatchClick(el);
      if(ok) return true;
      // fallback: tentar clicar no parent button
      let p = el;
      while(p && p.tagName!=='BUTTON' && p.parentElement){ p = p.parentElement; }
      if(p && p!==el){ ok = tryDispatchClick(p); if(ok) return true; }
    }
    // esperar de forma ass√≠ncrona (mas aqui loop s√≠ncrono com blocking curto n√£o recomendado)
    const start = Date.now();
    while(Date.now()-start < delayMs){} // pequeno busy-wait compat√≠vel com userscripts
  }
  return false;
}

/* ---------- REGISTRO E HIST√ìRICO ---------- */
function registrarPausa(n){
  const now=new Date();
  if(estadoAtual.ativa){
    const d = Math.round((now.getTime()-estadoAtual.inicio.getTime())/1000);
    if(d>0){
      historicoPausas.push({ tipo: estadoAtual.tipo, inicio: estadoAtual.inicio.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}), fim: now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}), duracao: formatDur(d) });
      renderizarHistoricoLog(); renderizarEstatisticas();
    }
  }
  estadoAtual = { tipo:n, inicio: now, ativa: n!=='Logoff' };
  atualizarUI();
}
/* ---------- A√á√ïES (usa clicarRobustoSync) ---------- */
const DELAY_ABRIR_MENU = 850, DELAY_ABRIR_SUBMENU = 520, DELAY_FECHAR_MENU = 200;

function abrirMenu() {
  return clicarRobustoSync(SELECTORES.MENU_STATUS_TOGGLE);
}
function clicarVoltarSubmenu(){ return clicarRobustoSync(SELECTORES.VOLTAR_SUBMENU); }

/* a√ß√µes diretas e em submenu (tenta ser resiliente) */
function executarLogicaMenuSimples(seletor, nome){
  if(!abrirMenu()) return false;
  const ok = clicarRobustoSync(seletor);
  if(!ok){ clicarRobustoSync(SELECTORES.MENU_STATUS_TOGGLE); }
  return ok;
}
function executarLogicaSubMenu(menuTexto, itemTexto){
  if(!abrirMenu()) return false;
  // clicar no menu (p.ex. "Ocupado", "Intervalo")
  const clicouMenu = clicarRobustoSync(SELECTORES.STATUS_LABEL_TEXT, menuTexto, 6, 220);
  if(!clicouMenu){ clicarRobustoSync(SELECTORES.MENU_STATUS_TOGGLE); return false; }
  // aguardar e tentar o item
  const okItem = clicarRobustoSync(SELECTORES.STATUS_LABEL_TEXT, itemTexto, 6, 220);
  // fechar submenu se abriu
  setTimeout(()=> clicarVoltarSubmenu(), DELAY_FECHAR_MENU);
  return okItem;
}

/* a√ß√µes espec√≠ficas */
function executarLogicaNaFila(){ // tenta toggle direto ou fallback
  let el=document.querySelector(SELECTORES.NA_FILA_DIRETO);
  if(el && el.offsetHeight!==0){ return tryDispatchClick(el); }
  // fallback para toggle host (shadow)
  try{
    const gux = document.querySelector(SELECTORES.NA_FILA_TOGGLE_HOST);
    if(gux && gux.shadowRoot){
      const slider = gux.shadowRoot.querySelector('div[role="checkbox"]');
      if(slider) return tryDispatchClick(slider);
    }
  }catch(e){}
  return false;
}
function executarLogicaRefeicao(){ return executarLogicaMenuSimples(SELECTORES.REFEICAO,'Refei√ß√£o'); }
function executarLogicaDisponivel(){ return executarLogicaMenuSimples(SELECTORES.DISPONIVEL,'Dispon√≠vel'); }
function executarLogicaTreinamento(){ return executarLogicaMenuSimples(SELECTORES.TREINAMENTO,'Treinamento'); }
function executarLogicaReuniao(){ return executarLogicaMenuSimples(SELECTORES.REUNIAO,'Reuni√£o'); }
function executarLogicaDescanso(){ return executarLogicaSubMenu("Intervalo","Pausa auricular"); }
function executarLogicaPausaOut(){ return executarLogicaSubMenu("Ocupado","Pausa out"); }
function executarLogicaBackoffice(){ return executarLogicaSubMenu("Ocupado","Atividade backoffice"); }
function executarLogicaFeedback(){ return executarLogicaSubMenu("Ocupado","Feedback"); }
function executarLogicaParticular(){ return executarLogicaSubMenu("Ausente","Particular"); }
function executarLogicaQuestoesSaude(){ return executarLogicaSubMenu("Ausente","Quest√µes de sa√∫de"); }
function executarLogicaLogoff(){
  if(!confirm("Fazer logoff? Hist√≥rico ser√° zerado.")) return false;
  if(!abrirMenu()) return false;
  const ok = clicarRobustoSync(SELECTORES.LOGOFF,"Fazer logoff",6,240);
  if(ok){ historicoPausas=[]; estadoAtual={tipo:'Logoff',inicio:new Date(),ativa:false}; atualizarUI(); renderizarHistoricoLog(); renderizarEstatisticas(); if(isAgendamentoAtivo) toggleAgendamento(); }
  else clicarRobustoSync(SELECTORES.MENU_STATUS_TOGGLE);
  return ok;
}

/* ---------- ORQUESTRADORES ---------- */
function iniciarNaFila(auto=false){ registrarPausa("Na fila"); executarLogicaNaFila(); }
function iniciarRefeicao(auto=false){ registrarPausa("Refei√ß√£o"); executarLogicaRefeicao(); }
function voltarDisponivel(auto=false){ registrarPausa("Dispon√≠vel"); executarLogicaDisponivel(); }
function iniciarTreinamento(auto=false){ registrarPausa("Treinamento"); executarLogicaTreinamento(); }
function iniciarReuniao(auto=false){ registrarPausa("Reuni√£o"); executarLogicaReuniao(); }
function iniciarDescanso(auto=false){ registrarPausa("Pausa auricular"); executarLogicaDescanso(); }
function iniciarPausaOut(auto=false){ registrarPausa("Pausa out"); executarLogicaPausaOut(); }
function iniciarBackoffice(auto=false){ registrarPausa("Backoffice"); executarLogicaBackoffice(); }
function iniciarFeedback(auto=false){ registrarPausa("Feedback"); executarLogicaFeedback(); }
function iniciarParticular(auto=false){ registrarPausa("Particular"); executarLogicaParticular(); }
function iniciarQuestoesSaude(auto=false){ registrarPausa("Sa√∫de"); executarLogicaQuestoesSaude(); }
function realizarLogoff(auto=false){ executarLogicaLogoff(); }

/* ---------- SCHEDULER (sincronizado com in√≠cio do minuto) ---------- */
function verificarEExecutarAgendamentos(){
  if(!isAgendamentoAtivo || isAutomacaoPausada) return;
  const now=new Date();
  const hh = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const seg = now.getSeconds();
  // limpar notifica√ß√µes expiradas
  Object.keys(window).forEach(k=>{ if(k.startsWith('notif_')){ const p=k.split('_')[1]; if(p < hh){ clearTimeout(window[k]); delete window[k]; } } });

  const ev = PAUSAS_AGENDADAS.find(p=>p.hora===hh);
  if(ev && ultimoEventoProcessado !== hh){
    console.log('[AGEND] executando',ev);
    mapearEexecutarAcao(ev.status);
    ultimoEventoProcessado = hh;
    if(ev.status.toLowerCase()==='logoff'){ setTimeout(()=>{ if(isAgendamentoAtivo) toggleAgendamento(); },500); }
    return;
  }
  if(!ev) ultimoEventoProcessado = null;

  // notifica√ß√µes de anteced√™ncia
  if(seg < 15){
    const next = new Date(now.getTime()+60000);
    const nextH = `${String(next.getHours()).padStart(2,'0')}:${String(next.getMinutes()).padStart(2,'0')}`;
    const ev2 = PAUSAS_AGENDADAS.find(p=>p.hora===nextH);
    if(ev2){
      const antic = configNotificacao.antecedenciaSegundos || 15;
      const sN = Math.max(0, (60-antic)-seg);
      const id = `notif_${ev2.hora}_${ev2.status}`;
      if(sN>0 && !window[id]){
        window[id] = setTimeout(()=>{ mostrarNotificacao(ev2); delete window[id]; }, sN*1000);
      }
    }
  }
}
function iniciarSchedulerSincronizado(){
  if(!isAgendamentoAtivo) return;
  if(schedulerInterval) clearInterval(schedulerInterval);
  schedulerInterval = setInterval(verificarEExecutarAgendamentos, 1000*30); // checa a cada 30s para ser responsivo
  verificarEExecutarAgendamentos();
}
function sincronizarEIniciarScheduler(){
  if(schedulerInterval) clearInterval(schedulerInterval);
  if(syncTimeout) clearTimeout(syncTimeout);
  const s = new Date().getSeconds();
  const delay = (60 - s) * 1000 + 50;
  syncTimeout = setTimeout(iniciarSchedulerSincronizado, delay);
}

/* ---------- TOGGLE AGENDAMENTO ---------- */
function toggleAgendamento(){
  isAgendamentoAtivo = !isAgendamentoAtivo;
  const btn = document.getElementById('btn-toggle-agendamento');
  const btPause = document.getElementById('btn-pause-resume-agendamento');
  if(isAgendamentoAtivo){
    PAUSAS_AGENDADAS = load(STORAGE.PAUSAS) || PAUSAS_AGENDADAS;
    ultimoEventoProcessado = null; isAutomacaoPausada = false;
    if(btn) { btn.textContent = "Desligar Automa√ß√£o"; btn.style.background='linear-gradient(135deg,#dc3545,#e84a5f)'; }
    if(btPause){ btPause.style.display='inline-block'; btPause.textContent='Pausar ‚è∏Ô∏è'; btPause.style.background='linear-gradient(135deg,#ffc107,#ffd25a)'; btPause.style.color='#000'; }
    sincronizarEIniciarScheduler();
  } else {
    if(schedulerInterval) clearInterval(schedulerInterval);
    if(syncTimeout) clearTimeout(syncTimeout);
    schedulerInterval = null; syncTimeout = null; isAutomacaoPausada=false;
    if(btn){ btn.textContent = "Ligar Automa√ß√£o"; btn.style.background='linear-gradient(135deg,#23a745,#2dc24f)'; }
    if(btPause) btPause.style.display='none';
  }
}
function togglePausaAutomacao(){
  if(!isAgendamentoAtivo) return;
  isAutomacaoPausada = !isAutomacaoPausada;
  const b = document.getElementById('btn-pause-resume-agendamento');
  if(isAutomacaoPausada){ if(b){ b.textContent="Retomar ‚ñ∂Ô∏è"; b.style.background='linear-gradient(135deg,#007FFF,#009cff)'; b.style.color='#fff'; } }
  else { if(b){ b.textContent="Pausar ‚è∏Ô∏è"; b.style.background='linear-gradient(135deg,#ffc107,#ffd25a)'; b.style.color='#000'; } verificarEExecutarAgendamentos(); }
}

/* ---------- EDIT / IMPORT / EXPORT ---------- */
function adicionarNovoHorario(){
  const iH=document.getElementById('novo-horario-hora'), iS=document.getElementById('novo-horario-status');
  if(!iH||!iS) return alert('Campos ausentes');
  const h=iH.value, s=iS.value.trim();
  if(!h||!s) return alert('Preencha hora e status');
  const exists = PAUSAS_AGENDADAS.find(p=>p.hora===h);
  if(exists && !confirm(`J√° existe ${h}. Substituir?`)) return;
  PAUSAS_AGENDADAS = PAUSAS_AGENDADAS.filter(p=>p.hora!==h);
  PAUSAS_AGENDADAS.push({hora:h,status:s});
  PAUSAS_AGENDADAS.sort((a,b)=>a.hora.localeCompare(b.hora));
  save(STORAGE.PAUSAS, PAUSAS_AGENDADAS);
  iH.value=''; iS.value='';
  renderizarAgendamentos();
  alert('Hor√°rio salvo! Reinicie a automa√ß√£o.');
}

function removerHorario(idx){ if(idx<0||idx>=PAUSAS_AGENDADAS.length) return; if(!confirm('Remover?')) return; PAUSAS_AGENDADAS.splice(idx,1); save(STORAGE.PAUSAS, PAUSAS_AGENDADAS); renderizarAgendamentos(); alert('Removido! Reinicie a automa√ß√£o.'); }

function importarConfiguracoes(){
  const inp = document.getElementById('import-file-input'); if(inp) inp.click();
}
function handleArquivoImportado(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = function(ev){
    try{
      const c = JSON.parse(ev.target.result);
      if(c.pausas){ save(STORAGE.PAUSAS, c.pausas); save(STORAGE.NOTIF, c.notificacoes||configNotificacao); save(STORAGE.POS_MAIN, c.posicoes?.main); save(STORAGE.POS_CFG, c.posicoes?.config); alert('Importado! Recarregue a automa√ß√£o.'); }
      else alert('Arquivo inv√°lido');
    }catch(err){ alert('Arquivo inv√°lido'); }
  };
  r.readAsText(f);
}
/* ---------- UI / DRAG (V51.2 - pointer + inertia + overlay) ---------- */
function criarDragOverlay(){
  if(document.getElementById('pausa-script-drag-overlay')) return;
  const o=document.createElement('div');
  o.id='pausa-script-drag-overlay';
  o.style.cssText='position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2147483645;display:none;cursor:grabbing;';
  document.body.appendChild(o);
  return o;
}
function salvarPos(elKey, el){
  try{
    if(!el) return;
    let obj={};
    if(el.style.top && el.style.left){ obj={top:el.style.top,left:el.style.left}; }
    else { const r=el.getBoundingClientRect(); obj={bottom:'30px',right:'30px'}; }
    save(elKey, obj);
  }catch(e){}
}
function carregarPos(elKey){ try{ return load(elKey); }catch(e){return null;} }

/* drag otimizado (pointer events + rAF + inertia) */
function setupGPUDrag(elementId, headerId, storageKey){
  const el=document.getElementById(elementId), hdr=document.getElementById(headerId), ic=document.getElementById('pausa-script-icone'), overlay=document.getElementById('pausa-script-drag-overlay');
  if(!el||!hdr||!overlay) return;
  let dragging=false, startX=0, startY=0, initL=0, initT=0, curX=0, curY=0, lastX=0, lastY=0, lastT=0, vx=0, vy=0, moved=false, raf=null;
  const THRESH=6, FRICTION=0.92, MIN_V=0.3;

  function setNoSelect(flag){ document.documentElement.style.userSelect=flag?'none':''; document.documentElement.style.touchAction=flag?'none':''; }

  function onDown(e){
    if(!hdr.contains(e.target) && !(ic&&ic.contains(e.target))) return;
    e.preventDefault();
    dragging=true; moved=false;
    startX=e.clientX; startY=e.clientY;
    lastX=e.clientX; lastY=e.clientY; lastT=performance.now();
    const rect=el.getBoundingClientRect(); initL=rect.left; initT=rect.top;
    el.style.left=initL+'px'; el.style.top=initT+'px'; el.style.transition='none'; el.style.transform='none';
    overlay.style.display='block'; setNoSelect(true);
    document.addEventListener('pointermove', onMove, {passive:false}); document.addEventListener('pointerup', onUp,{passive:false}); document.addEventListener('pointercancel', onUp,{passive:false});
  }
  function onMove(e){
    if(!dragging) return;
    e.preventDefault();
    const now=performance.now(), dt=Math.max(1, now-lastT);
    const dx=e.clientX-lastX, dy=e.clientY-lastY;
    vx = (dx/dt)*16.6; vy=(dy/dt)*16.6;
    lastX=e.clientX; lastY=e.clientY; lastT=now;
    curX = e.clientX - startX; curY = e.clientY - startY;
    if(!moved && (Math.abs(curX)>THRESH||Math.abs(curY)>THRESH)) moved=true;
    if(raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=>{ el.style.transform = `translate3d(${curX}px,${curY}px,0)`; });
  }
  function animateInertia(){
    vx *= FRICTION; vy *= FRICTION;
    curX += vx; curY += vy;
    let left = initL + curX, top = initT + curY;
    const maxL = Math.max(0, window.innerWidth - el.offsetWidth), maxT = Math.max(0, window.innerHeight - el.offsetHeight);
    left = Math.max(0, Math.min(left, maxL)); top = Math.max(0, Math.min(top, maxT));
    el.style.transform = 'none';
    el.style.left = left+'px'; el.style.top = top+'px';
    if(Math.hypot(vx,vy) > MIN_V){
      requestAnimationFrame(animateInertia);
    } else {
      el.style.transition='left 140ms ease-out, top 140ms ease-out';
      salvarPos(storageKey, el);
      overlay.style.display='none';
      setNoSelect(false);
      globalWasDragging = moved;
      setTimeout(()=> globalWasDragging=false, 140);
    }
  }
  function onUp(e){
    if(!dragging) return;
    dragging=false;
    document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); document.removeEventListener('pointercancel', onUp);
    overlay.style.display='block';
    if(!moved){
      overlay.style.display='none'; setNoSelect(false); globalWasDragging=false; return;
    }
    // start inertia
    animateInertia();
  }
  hdr.addEventListener('pointerdown', onDown);
  if(ic) ic.addEventListener('pointerdown', onDown);
  el.setAttribute('tabindex','0');
}

/* ---------- UI RENDER ---------- */
function renderizarAgendamentos(){
  const l=document.getElementById('agendamento-lista'); if(!l) return; l.innerHTML='';
  if(!PAUSAS_AGENDADAS || PAUSAS_AGENDADAS.length===0){ l.innerHTML='<p style="color:#999">Nenhum hor√°rio agendado.</p>'; return; }
  PAUSAS_AGENDADAS.forEach((p,idx)=>{
    const item=document.createElement('div'); item.style.cssText='display:flex;justify-content:space-between;padding:6px;border-bottom:1px dashed rgba(255,255,255,0.08);font-size:12px';
    const left=document.createElement('div'); left.innerHTML=`<strong>${p.hora}</strong> ${p.status}`; const right=document.createElement('div');
    const e=document.createElement('button'); e.textContent='‚úèÔ∏è'; e.onclick=()=>{ document.getElementById('novo-horario-hora').value=p.hora; document.getElementById('novo-horario-status').value=p.status; };
    const r=document.createElement('button'); r.textContent='‚ùå'; r.onclick=()=> removerHorario(idx);
    right.appendChild(e); right.appendChild(r); item.appendChild(left); item.appendChild(right); l.appendChild(item);
  });
}
function renderizarHistoricoLog(){
  const l=document.getElementById('historico-log'); if(!l) return; l.innerHTML='';
  if(!historicoPausas.length){ l.innerHTML='<p style="color:#999">Nenhum registro.</p>'; return; }
  [...historicoPausas].reverse().forEach(p=>{ const d=document.createElement('div'); d.style.cssText='padding:6px;border-bottom:1px dashed rgba(255,255,255,0.06);font-size:12px'; d.innerHTML=`<strong>${p.tipo}</strong>: ${p.inicio} √†s ${p.fim} <span style="color:#0ff">(Dur: ${p.duracao})</span>`; l.appendChild(d); });
}
function renderizarEstatisticas(){
  const s=document.getElementById('estatisticas-pausas'); if(!s) return; s.innerHTML=''; if(!historicoPausas.length){ s.innerHTML='<p style="color:#999">Sem estat√≠sticas.</p>'; return; }
  const map={}; historicoPausas.forEach(p=>{ if(!map[p.tipo]) map[p.tipo]={c:0,s:0}; map[p.tipo].c++; map[p.tipo].s += secFromHMS(p.duracao); });
  const keys=Object.keys(map).sort(); keys.forEach(k=>{ const row=document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;padding:4px;font-size:12px'; row.innerHTML=`<strong>${k} (x${map[k].c})</strong><span>${formatDur(map[k].s)}</span>`; s.appendChild(row); });
}

/* ---------- UI CREATION (compact) ---------- */
function criarUI(){
  const id='pausa-script-container'; const old=document.getElementById(id); if(old) old.remove();
  const c=document.createElement('div'); c.id=id;
  const p = load(STORAGE.POS_MAIN);
  const posCss = p ? (p.top?`top:${p.top};left:${p.left};`:`bottom:${p.bottom};right:${p.right};`) : 'bottom:30px;right:30px;';
  c.style.cssText = `${posCss}position:fixed;z-index:2147483647;padding:8px;border-radius:10px;background:linear-gradient(145deg,#191b21,#23232a);color:#e0e0e0;box-shadow:0 8px 20px rgba(0,0,0,.5);cursor:grab;user-select:none;`;
  c.innerHTML = `
    <div id="pausa-script-icone" style="display:flex;align-items:center;gap:8px;cursor:grab"><span id="pausa-script-clock-dot" style="display:none;width:8px;height:8px;border-radius:50%"></span><span id="top-bar-time">--:--:--</span></div>
    <div id="pausa-script-conteudo" style="display:none;width:320px;padding-top:8px">
      <div id="pausa-script-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;color:#0ff;font-size:14px">üõ†Ô∏è Gerenciador</h3>
        <div style="display:flex;gap:8px;align-items:center"><span id="pausa-script-header-clock" style="font-family:monospace;color:#f1fa8c">--:--:--</span><span id="btn-abrir-config" style="cursor:pointer">‚öôÔ∏è</span><span id="btn-minimizar" style="cursor:pointer;color:#ff5555">[X]</span></div>
      </div>
      <div id="status-display" style="margin-bottom:8px">Status: <strong id="current-status" style="color:#50fa7b">Dispon√≠vel</strong></div>
      <div style="display:flex;gap:8px;margin-bottom:8px"><button id="btn-toggle-agendamento" class="script-btn">Ligar Automa√ß√£o</button><button id="btn-pause-resume-agendamento" class="script-btn" style="display:none">Pausar ‚è∏Ô∏è</button></div>
      <div id="buttons-container" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
        <button id="btn-disponivel" class="script-btn">üü¢ Dispon√≠vel</button><button id="btn-na-fila" class="script-btn">üéß Na Fila</button>
        <button id="btn-refeicao" class="script-btn">üçî Refei√ß√£o</button><button id="btn-descanso" class="script-btn">‚òï Pausa auricular</button>
        <button id="btn-pausa-out" class="script-btn">‚õî Pausa Out</button><button id="btn-treinamento" class="script-btn">üìö Treinamento</button>
        <button id="btn-backoffice" class="script-btn">üìÅ Backoffice</button><button id="btn-feedback" class="script-btn">üìù Feedback</button>
        <button id="btn-particular" class="script-btn">üîí Particular</button><button id="btn-saude" class="script-btn">ü©∫ Sa√∫de</button>
      </div>
      <div style="display:flex;gap:8px"><button id="btn-reuniao" class="script-btn">üßë‚Äçü§ù‚Äçüßë Reuni√£o</button><button id="btn-logoff" class="script-btn">üö™ Fazer Logoff</button></div>
    </div>
  `;
  document.body.appendChild(c);
  criarDragOverlay();
  setupGPUDrag('pausa-script-container','pausa-script-header',STORAGE.POS_MAIN);

  c.addEventListener('click', (ev)=>{
    if(globalWasDragging) return;
    const t = ev.target.closest('button'), s = ev.target.closest('span#btn-minimizar, span#btn-abrir-config'), o = ev.target.closest('div#pausa-script-icone');
    if(!t && !s && !o) return;
    const conteudo = document.getElementById('pausa-script-conteudo');
    if(o && conteudo && conteudo.style.display==='none'){ toggleVisibilidade(); return; }
    const id = (t||s||o).id;
    switch(id){
      case'btn-na-fila': iniciarNaFila(false); break;
      case'btn-refeicao': iniciarRefeicao(false); break;
      case'btn-descanso': iniciarDescanso(false); break;
      case'btn-pausa-out': iniciarPausaOut(false); break;
      case'btn-disponivel': voltarDisponivel(false); break;
      case'btn-logoff': realizarLogoff(false); break;
      case'btn-treinamento': iniciarTreinamento(false); break;
      case'btn-reuniao': iniciarReuniao(false); break;
      case'btn-backoffice': iniciarBackoffice(false); break;
      case'btn-feedback': iniciarFeedback(false); break;
      case'btn-particular': iniciarParticular(false); break;
      case'btn-saude': iniciarQuestoesSaude(false); break;
      case'btn-toggle-agendamento': toggleAgendamento(); break;
      case'btn-pause-resume-agendamento': togglePausaAutomacao(); break;
      case'btn-minimizar': toggleVisibilidade(); break;
      case'btn-abrir-config': toggleVisibilidadeConfig(); break;
    }
  });
  // inicializar labels/estado
  registrarPausa(estadoAtual.tipo);
  adicionarAtalho();
  setInterval(atualizarUI,1000);
}

/* ---------- restante UI de config (compact) ---------- */
function criarUIConfiguracoes(){
  const id='pausa-script-config-container'; const old=document.getElementById(id); if(old) old.remove();
  const c=document.createElement('div'); c.id=id; document.body.appendChild(c);
  const p = load(STORAGE.POS_CFG);
  c.style.cssText = `${p? (p.top?`top:${p.top};left:${p.left};`:`bottom:${p.bottom};right:${p.right};`) : 'bottom:30px;right:340px;'}position:fixed;width:340px;z-index:2147483646;background:linear-gradient(145deg,#1b1f29,#23232a);color:#e0e0e0;padding:12px;border-radius:8px;display:none;max-height:80vh;overflow:auto;`;
  c.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">‚öôÔ∏è Config & Hist√≥rico</h3><span id="btn-fechar-config" style="cursor:pointer;color:#ff5555">[X]</span></div>
    <div id="estatisticas-pausas" style="margin-top:8px"></div>
    <details style="margin-top:8px"><summary>üîî Notifica√ß√µes</summary>
      <div style="display:flex;flex-direction:column;gap:6px;padding-top:8px">
        <label><input type="checkbox" id="notif-ativadas"> Ativar visuais</label>
        <label><input type="checkbox" id="notif-som"> Ativar som</label>
        <label>Anteced√™ncia (s): <input type="number" id="notif-tempo" min="5" max="55" step="5" style="width:70px"></label>
      </div>
    </details>
    <details open style="margin-top:8px"><summary>Editar Hor√°rios</summary>
      <div id="agendamento-lista" style="max-height:150px;overflow:auto;margin-top:8px"></div>
      <div style="display:flex;gap:6px;margin-top:8px"><input id="novo-horario-hora" type="time"><input id="novo-horario-status" placeholder="Ex: Refei√ß√£o" style="flex:1"><button id="btn-adicionar-horario">+</button></div>
      <input id="import-file-input" type="file" accept=".json" style="display:none">
    </details>
    <details style="margin-top:8px"><summary>Hist√≥rico</summary><div id="historico-log" style="max-height:150px;overflow:auto;margin-top:8px"></div></details>
    <details style="margin-top:8px"><summary>Diagn√≥stico</summary><div style="margin-top:8px"><button id="btn-verificar-seletores">Verificar Seletores</button><div id="seletores-resultados" style="max-height:150px;overflow:auto;margin-top:8px"></div></div></details>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="btn-exportar-config">Exportar</button><button id="btn-importar-config">Importar</button></div>
  `;
  setupGPUDrag('pausa-script-config-container','pausa-script-config-header',STORAGE.POS_CFG);
  c.querySelector('#btn-fechar-config').onclick = toggleVisibilidadeConfig;
  c.querySelector('#btn-adicionar-horario').onclick = adicionarNovoHorario;
  c.querySelector('#btn-verificar-seletores').onclick = verificarSeletoresEAtualizarUI;
  c.querySelector('#btn-exportar-config').onclick = exportarConfiguracoes;
  c.querySelector('#btn-importar-config').onclick = importarConfiguracoes;
  const cN=document.getElementById('notif-ativadas'), cS=document.getElementById('notif-som'), iT=document.getElementById('notif-tempo');
  if(cN) cN.checked = configNotificacao.ativadas; if(cS) cS.checked = configNotificacao.somAtivado; if(iT) iT.value = configNotificacao.antecedenciaSegundos;
  function salvarNotif(){ configNotificacao.ativadas = !!cN.checked; configNotificacao.somAtivado = !!cS.checked; let t=parseInt(iT.value,10); if(isNaN(t)||t<5) t=5; if(t>55) t=55; configNotificacao.antecedenciaSegundos = t; save(STORAGE.NOTIF, configNotificacao); }
  if(cN) cN.onchange = salvarNotif; if(cS) cS.onchange = salvarNotif; if(iT) iT.onchange = salvarNotif;
  renderizarAgendamentos(); renderizarHistoricoLog(); renderizarEstatisticas();
}

/* ---------- UI HELPERS ---------- */
function toggleVisibilidade(){
  const c=document.getElementById('pausa-script-container'), o=document.getElementById('pausa-script-conteudo'), i=document.getElementById('pausa-script-icone');
  if(!c||!o||!i) return;
  if(o.style.display!=='none'){ o.style.display='none'; i.style.display='flex'; c.style.width='auto'; c.style.padding='6px'; c.style.cursor='grab'; }
  else { o.style.display='block'; i.style.display='none'; c.style.width='320px'; c.style.padding='10px'; const h=c.querySelector('#pausa-script-header'); if(h) h.style.cursor='move'; if(!c.style.left){ const r=c.getBoundingClientRect(); c.style.left = r.left+'px'; c.style.top = r.top+'px'; } }
}
function toggleVisibilidadeConfig(){ const c=document.getElementById('pausa-script-config-container'); if(!c) return; c.style.display = (c.style.display==='block') ? 'none' : 'block'; if(c.style.display==='block'){ renderizarAgendamentos(); renderizarHistoricoLog(); renderizarEstatisticas(); } }

/* ---------- DIAGN√ìSTICO ---------- */
function verificarSeletoresEAtualizarUI(){
  const out=document.getElementById('seletores-resultados'); if(!out) return;
  out.innerHTML = '<p style="color:#bbb">Verificando...</p>';
  setTimeout(()=>{
    let html='<ul style="list-style:none;padding:0">';
    Object.keys(SELECTORES).forEach(k=>{ const s=SELECTORES[k]; const e=document.querySelector(s); const ok=!!e; html += `<li style="padding:4px;border-bottom:1px dashed rgba(255,255,255,0.04)"><strong>${k}</strong> <code>${s}</code> <span style="color:${ok?'#50fa7b':'#ff6b6b'}">${ok?'Ok':'Fail'}</span></li>`; });
    html += '</ul>';
    out.innerHTML = html;
  },50);
}

/* ---------- UI STATS / UPDATE ---------- */
function atualizarUI(){
  const now=new Date(); const hh=now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const t = document.getElementById('top-bar-time'), h = document.getElementById('pausa-script-header-clock'), s = document.getElementById('current-status');
  if(t) t.textContent = hh; if(h) h.textContent = hh;
  if(s){ let extra=''; if(estadoAtual.ativa){ extra = ' ('+formatDur(Math.round((now - estadoAtual.inicio)/1000))+')'; } s.textContent = estadoAtual.tipo + extra; }
}

/* ---------- START ---------- */
console.log('[GERENCIADOR V51.2] iniciando...');
setTimeout(()=>{
  try{
    criarUI();
    criarUIConfiguracoes();
    renderizarAgendamentos();
    document.addEventListener('click', desbloquearAudio, {once:true});
  }catch(e){ console.error('[GERENCIADOR] erro init', e); }
},900);

/* ---------- fun√ß√µes antigas reutilizadas que ficaram no escopo (declara√ß√µes r√°pidas) ---------- */
function adicionarAtalho(){ document.addEventListener('keydown', e=>{ const c=e.ctrlKey||e.metaKey, s=e.shiftKey; if(document.activeElement && ['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return; if(c&&s&&e.key==='1'){ e.preventDefault(); toggleVisibilidade(); } }); }
function renderizarAgendamentos(){} // placeholder - definido acima
function renderizarHistoricoLog(){} // placeholder - definido acima
function renderizarEstatisticas(){} // placeholder - definido acima

// fim do IIFE
})();
